# .github/workflows/ci.yml
name: CI

# Start the build with a push to any branch and with a pull request in the main
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    # Choosing different operating systems for testing
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        # Defining the Qt architecture for each OS
        include:
          - os: ubuntu-latest
            qt_arch: 'linux_gcc_64'        # For Linux
          - os: windows-latest
            qt_arch: 'win64_mingw'   # For Windows (suitable for MinGW/LLVM-MinGW)
          - os: macos-latest
            qt_arch: 'clang_64'      # For macOS

    runs-on: ${{ matrix.os }}

    steps:
    # 1. Clone the repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Installing Qt
    # Uses the official action to install Qt
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.10.2' # target Qt version
        host: ${{ matrix.os == 'ubuntu-latest' && 'linux' || matrix.os == 'windows-latest' && 'windows' || 'mac' }}
        target: 'desktop'
        arch: ${{ matrix.qt_arch }}
        # For Windows: arch: 'win64_msvc2019_64' or 'win64_mingw' (depending on your build)
        # If you are using MinGW on Windows, change the arch below
        modules: '' # Add modules if necessary, for example: 'qtcharts qtnetworkauth'
        tools: ''

    # 3. Installing CMake and Ninja (if not installed)
    - name: Install CMake and Ninja (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build

    - name: Install CMake and Ninja (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake ninja

    # For Windows, CMake and Ninja may already be installed with Qt, but you can make sure
    # AND we need to ensure the MinGW path is correctly added to PATH
    - name: Install CMake and Ninja (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
        choco install ninja

    # Setup PATH for Qt and MinGW on Windows to ensure compilers are found
    - name: Setup PATH for Qt and MinGW (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Find the Qt installation directory (usually under GITHUB_WORKSPACE\Qt\6.10.2\mingw_64 or similar)
        # The exact path depends on how install-qt-action sets it up
        $qtBasePath = "$env:GITHUB_WORKSPACE\Qt\6.10.2"
        $qtArchPath = "mingw_64" # This corresponds to win64_mingw
        $qtInstallPath = Join-Path $qtBasePath $qtArchPath
        Write-Host "Qt Install Path: $qtInstallPath"

        # Add the bin directories to PATH
        $binPaths = @("$qtInstallPath\bin", "$qtInstallPath\libexec")
        foreach ($path in $binPaths) {
            if (Test-Path $path) {
                $env:PATH = "$path;$env:PATH"
                Write-Host "Added to PATH: $path"
            } else {
                Write-Host "Warning: Path does not exist: $path"
            }
        }
        # Verify the compiler is accessible
        try {
            $gppVersion = & g++ --version
            Write-Host "g++ found: $($gppVersion[0])"
        } catch {
            Write-Host "Error: g++ not found in PATH."
            Write-Host "Current PATH: $env:PATH"
            exit 1
        }
        # Verify CMake and Ninja
        try {
            $cmakeVersion = & cmake --version
            Write-Host "cmake found: $($cmakeVersion[0])"
        } catch {
            Write-Host "Error: cmake not found in PATH."
            exit 1
        }
        try {
            $ninjaVersion = & ninja --version
            Write-Host "ninja found: $($ninjaVersion)"
        } catch {
            Write-Host "Error: ninja not found in PATH."
            exit 1
        }

    # 4. Build example
    - name: Build Example App (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        cd example
        mkdir build
        cd build
        cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release
        cmake --build .

    - name: Build Example App (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        cd example
        mkdir build
        cd build

        # Getting the path to the installed MinGW inside Qt
        $qtPath = "$env:GITHUB_WORKSPACE\Qt\6.10.2\mingw_64"
        $mingwBin = "$qtPath\bin"

        # Check that g++ exists
        if (-Not (Test-Path "$mingwBin\g++.exe")) {
            Write-Error "g++.exe not found in $mingwBin"
            exit 1
        }

        # Explicitly setting environment variables for CMake
        $env:CXX = "$mingwBin\g++.exe"
        $env:CC = "$mingwBin\gcc.exe"
        $env:PATH = "$mingwBin;$qtPath\libexec;$env:PATH"

        # Running CMake with explicit indication of the generator and compiler
        cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release `
                 -DCMAKE_C_COMPILER="$mingwBin\gcc.exe" `
                 -DCMAKE_CXX_COMPILER="$mingwBin\g++.exe" `
                 -DCMAKE_MAKE_PROGRAM=ninja

        if ($LASTEXITCODE -ne 0) {
            Write-Error "CMake configuration failed."
            exit $LASTEXITCODE
        }

        cmake --build .
        if ($LASTEXITCODE -ne 0) {
            Write-Error "Build failed."
            exit $LASTEXITCODE
        }

    # (Optional) Running the example (only if it is headless)
    # - name: Run Example App (Linux/macOS)
    #   if: runner.os != 'Windows'
    #   run: |
    #     cd example/build
    #     ./ExampleApp # # or whatever the executable file is called.

    # - name: Run Example App (Windows)
    #   if: runner.os == 'Windows'
    #   shell: pwsh
    #   run: |
    #     cd example/build
    #     .\ExampleApp.exe # or whatever the executable file is called.
